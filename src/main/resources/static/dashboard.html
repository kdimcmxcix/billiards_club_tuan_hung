<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Dashboard - Billiards Club Tu·∫•n H√πng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./index.css">

    <!-- jQuery (ph·∫£i ƒë·∫∑t tr∆∞·ªõc Bootstrap JS) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Bundle JS (g·ªìm c·∫£ Popper + Modal support) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Day.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);
    </script>
</head>


<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand me-5" href="#">
                <div class="brand-logo">
                    <img src="./img/bidaTuanHung.png" alt="">
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-3 w-100 justify-content-between">
                    <li class="nav-item">
                        <a id="link-revenue-statistics" class="nav-link active" href="#"><i
                                class="fa-solid fa-chart-simple"></i> T·ªïng quan</a>
                    </li>
                    <li class="nav-item">
                        <a id="link-booking" class="nav-link" href="#"><i class="fas fa-table"></i> Ph√≤ng/B√†n</a>
                    </li>
                    <li class="nav-item">
                        <a id="link-products-management" class="nav-link" href="#"><i class="fa-solid fa-cube"></i> H√†ng
                            h√≥a</a>
                    </li>
                    <li class="nav-item">
                        <a id="link-store-fund" class="nav-link" href="#"><i class="fas fa-wallet"></i> Qu·ªπ c·ª≠a h√†ng</a>
                    </li>
                </ul>
            </div>
            <div id="logged-in-user" class="navbar-logged-in ms-5">
                <div class="user-circle-wrapper">
                    <div class="user-img-circle">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="user-dropdown-menu d-none">
                        <ul>
                            <span id="logged-username"></span>
                            <li id="log-out-div">
                                <i class="fa-solid fa-right-from-bracket"></i>
                                <span>ƒêƒÉng xu·∫•t</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- DOANH THU -->
    <section id="revenue-statistics-div">
        <!-- Bi·ªÉu ƒë·ªì doanh thu theo ng√†y -->
        <div class="container py-4">
            <h4 class="mb-3">Th·ªëng k√™ doanh thu theo ng√†y</h4>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="fromDate" class="form-label">T·ª´ ng√†y</label>
                    <input type="date" id="fromDate" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label for="toDate" class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" id="toDate" class="form-control" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="loadChartBtn">Xem th·ªëng k√™</button>
                </div>
            </div>
            <canvas id="revenueChart" height="100"></canvas>
        </div>
        <!-- ƒê∆°n h√†ng h√¥m nay -->
        <div class="container bg-white py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">ƒê∆°n h√†ng ng√†y <span id="currentDateDisplay"></span></h4>
                <div>
                    <button class="btn btn-outline-primary me-2" id="prevDateBtn"><i class="fa-solid fa-arrow-left"></i>
                        Ng√†y tr∆∞·ªõc</button>
                    <button class="btn btn-outline-primary" id="nextDateBtn">Ng√†y sau <i
                            class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>B√†n</th>
                            <th>B·∫Øt ƒë·∫ßu</th>
                            <th>K·∫øt th√∫c</th>
                            <th>Thanh to√°n</th>
                            <th>T·ªïng ti·ªÅn (VND)</th>
                            <th>Chi ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody id="orderListBody">
                        <!-- data here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-2">
                <strong>T·ªïng doanh thu:</strong> <span id="totalRevenueToday">0 ƒë</span>
            </div>
        </div>
    </section>

    <!-- M·ªû B√ÄN -->
    <section id="booking-div" class="d-none">
        <div class="container bg-white py-4">
            <div class="row g-4" id="table-list">
            </div>
            <div id="table-detail-panel" class="mt-4 p-3 border rounded bg-light">
                <p>Click v√†o b√†n ƒë·ªÉ xem chi ti·∫øt.</p>
            </div>
            <div id="menu-order-panel" class="mt-4 p-3 border rounded bg-light">
                <h5>Menu g·ªçi m√≥n</h5>
                <div id="menu-item-list" class="row g-3"></div>
                <div class="mt-3">
                    <button class="btn btn-success" id="confirmAddMenuBtn">
                        <i class="fa-solid fa-plus"></i> Th√™m v√†o ƒë∆°n
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Qu·∫£n l√Ω h√†ng -->
    <section id="itemsManagmentDiv" class="d-none">
        <div class="container bg-white py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Qu·∫£n l√Ω h√†ng h√≥a / M√≥n</h4>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#menuItemModal">
                    <i class="fa fa-plus"></i> Th√™m m√≥n m·ªõi
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered text-center">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n m√≥n</th>
                            <th>Lo·∫°i</th>
                            <th>Gi√° (VND)</th>
                            <th>S·ªë lu·ª£ng</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="menuItemListBody">
                        <!-- Data load here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- QU·∫¢N L√ù QU·ª∏ -->
    <section id="store-fund-div" class="d-none">
        <div class="container bg-white py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Qu·∫£n l√Ω qu·ªπ ti·ªÅn m·∫∑t c·ªßa c·ª≠a h√†ng</h4>
                <div>
                    <button class="btn btn-primary me-2" id="refreshSessionsBtn">
                        <i class="fa-solid fa-rotate"></i> T·∫£i l·∫°i
                    </button>
                    <button class="btn btn-outline-success" id="exportExcelBtn">
                        <i class="fa-solid fa-file-excel"></i> Xu·∫•t Excel
                    </button>
                </div>
            </div>
            <div class="mb-3">
                <label for="initialCashInput" class="form-label">Ti·ªÅn qu·ªπ ban ƒë·∫ßu (VND)</label>
                <input type="number" class="form-control" id="initialCashInput" placeholder="Nh·∫≠p s·ªë ti·ªÅn ban ƒë·∫ßu..."
                    min="0">
            </div>
            <button class="btn btn-success mb-3" id="updateInitialCashBtn">
                <i class="fa-solid fa-play"></i> C·∫≠p nh·∫≠t ti·ªÅn ƒë·∫ßu phi√™n
            </button>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nh√¢n vi√™n</th>
                            <th>Gi·ªù b·∫Øt ƒë·∫ßu</th>
                            <th>Gi·ªù k·∫øt th√∫c</th>
                            <th>Ti·ªÅn trong phi√™n ƒëƒÉng nh·∫≠p (VND)</th>
                        </tr>
                    </thead>
                    <tbody id="workingSessionTableBody">
                        <!-- Data render here -->
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                <strong>T·ªïng qu·ªπ: </strong><span id="totalFundAmount">0 ƒë</span>
            </div>
        </div>
        <nav>
            <ul class="pagination justify-content-center mt-3" id="pagination"></ul>
        </nav>
    </section>

    <!-- Modal Th√™m / S·ª≠a M√≥n -->
    <div class="modal fade" id="menuItemModal" tabindex="-1" aria-labelledby="menuItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="menuItemModalLabel">Th√™m / Ch·ªânh s·ª≠a M√≥n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="menuItemForm">
                        <input type="hidden" id="menuItemId">
                        <div class="mb-3">
                            <label class="form-label">T√™n m√≥n</label>
                            <input type="text" class="form-control" id="menuItemName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lo·∫°i</label>
                            <select name="" id="menuItemCategory" class="form-control">
                                <option value="N∆∞·ªõc">N∆∞·ªõc</option>
                                <option value="ƒê·ªì ƒÉn">ƒê·ªì ƒÉn</option>
                                <option value="Thu·ªëc">Thu·ªëc</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gi√° (VND)</label>
                            <input type="number" class="form-control" id="menuItemPrice" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë l∆∞·ª£ng nh·∫≠p</label>
                            <input type="number" class="form-control" id="menuItemQuantity" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary" id="saveMenuItemBtn">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal X√°c Nh·∫≠n T√≠nh Ti·ªÅn -->
    <div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- centered -->
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="confirmPaymentModalLabel">üíµ X√°c nh·∫≠n t√≠nh ti·ªÅn b√†n</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="paymentMethodSelect" class="form-label"><strong>Ph∆∞∆°ng th·ª©c thanh
                                to√°n:</strong></label>
                        <select class="form-select" id="paymentMethodSelect">
                            <option value="cash">üíµ Ti·ªÅn m·∫∑t</option>
                            <option value="momo">üì± Momo</option>
                            <option value="banking">üè¶ Chuy·ªÉn kho·∫£n</option>
                        </select>
                    </div>
                    <div id="payment-summary"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Quay l·∫°i</button>
                    <button type="button" class="btn btn-success" id="confirmFinishBtn">X√°c nh·∫≠n t√≠nh ti·ªÅn</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999"></div>

</body>
<script>
    /*** REGION 1 - Global variables - V√πng khai b√°o bi·∫øn, h·∫±ng s·ªë, tham s·ªë TO√ÄN C·ª§C */
    let revenueChart;
    let currentDay = new Date();
    const token = localStorage.getItem("token");
    let selectedTableId = null;
    let playingTimerInterval = null;
    const pageSize = 5;
    let currentPage = 0;

    /*** REGION 2 - V√πng g√°n / th·ª±c thi s·ª± ki·ªán cho c√°c elements */
    $(document).ready(function () {
        $("#exportExcelBtn").click(function () {
            fetch("http://localhost:8080/api/working-session/export")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Xu·∫•t Excel th·∫•t b·∫°i");
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(new Blob([blob]));
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "working_sessions.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                })
                .catch(error => {
                    showToastError("L·ªói khi xu·∫•t file Excel: " + error.message);
                });
        });

        $("#log-out-div").on("click", function () {
            const staffId = localStorage.getItem("staffId");

            if (!staffId) {
                // Kh√¥ng c√≥ staff -> x√≥a lu√¥n v√† v·ªÅ login
                localStorage.removeItem("token");
                localStorage.removeItem("staffId");
                window.location.href = "login.html";
                return;
            }

            // B1: T√¨m phi√™n ƒëang m·ªü
            $.ajax({
                url: `http://localhost:8080/api/working-session/staff/${staffId}`,
                method: 'GET',
                success: function (sessions) {
                    const activeSession = sessions.find(s => s.endTime == null);

                    if (!activeSession) {
                        doLogout();
                        return;
                    }

                    // B2: ƒê√≥ng ca = c·∫≠p nh·∫≠t endTime
                    const now = new Date().toISOString();

                    $.ajax({
                        url: `http://localhost:8080/api/working-session/${activeSession.id}`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            id: activeSession.id,
                            startTime: activeSession.startTime,
                            endTime: now,
                            cashInSession: activeSession.cashInSession,
                            staff: { id: staffId }
                        }),
                        success: function () {
                            doLogout();
                        },
                        error: function () {
                            showToastError('L·ªói khi ƒë√≥ng ca l√†m vi·ªác!');
                            doLogout(); // v·∫´n cho logout n·∫øu th·∫•t b·∫°i
                        }
                    });
                },
                error: function () {
                    doLogout(); // n·∫øu kh√¥ng g·ªçi ƒë∆∞·ª£c API th√¨ v·∫´n logout
                }
            });

            function doLogout() {
                localStorage.removeItem("token");
                localStorage.removeItem("staffId");
                window.location.href = "login.html";
            }
        });


        loadMenuItemManagement();
        loadWorkingSessions(currentPage);

        $('#refreshSessionsBtn').click(() => {
            loadWorkingSessions(currentPage);
        });

        if (!token) {
            showToastError("H·∫øt phi√™n ƒëƒÉng nh·∫≠p!");
            window.location.href = "login.html";
            return;
        }

        // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng
        $.ajax({
            url: "http://localhost:8080/api/auth/me",
            type: "GET",
            headers: {
                "Authorization": token
            },
            success: function (res) {
                $("#logged-username").html("T√†i kho·∫£n: " + res.username);
                localStorage.setItem("staffId", res.id);

                $.ajax({
                    url: "http://localhost:8080/api/working-session/start",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ staffId: res.id }),
                    headers: { Authorization: token }
                });
            },
            error: function () {
                window.location.href = "login.html";
            }
        });

        // Toggle dropdown khi click avatar
        $(".user-img-circle").on("click", function (e) {
            e.stopPropagation();
            $(".user-dropdown-menu").toggleClass("d-none");
        });

        // Click ngo√†i dropdown ƒë·ªÉ ·∫©n
        $(document).on("click", function (e) {
            if (!$(e.target).closest('.user-dropdown-menu').length &&
                !$(e.target).closest('.user-img-circle').length) {
                $(".user-dropdown-menu").addClass("d-none");
            }
        });

        // Xem chi ti·∫øt ƒë∆°n h√†ng
        $(document).on("click", ".fa-eye", function () {
            const detailId = $(this).data("target");
            $(`#${detailId}`).toggleClass("d-none");
        });

        // N√∫t l·ªçc bi·ªÉu ƒë·ªì
        $("#loadChartBtn").click(fetchRevenueData);

        // N√∫t l√πi ng√†y
        $("#prevDateBtn").click(() => {
            currentDay.setDate(currentDay.getDate() - 1);
            loadTodayOrders();
        });

        // N√∫t ti·∫øn ng√†y
        $("#nextDateBtn").click(() => {
            currentDay.setDate(currentDay.getDate() + 1);
            loadTodayOrders();
        });

        // Giao di·ªán chuy·ªÉn tab
        $("#link-revenue-statistics").on("click", function () {
            $(this).addClass("active");
            $("#link-booking").removeClass("active");
            $("#link-products-management").removeClass("active");
            $("#link-store-fund").removeClass("active");
            $("#revenue-statistics-div").removeClass("d-none");
            $("#booking-div").addClass("d-none");
            $("#itemsManagmentDiv").addClass("d-none");
            $("#store-fund-div").addClass("d-none");
        });

        $("#link-booking").on("click", function () {
            $(this).addClass("active");
            $("#link-revenue-statistics").removeClass("active");
            $("#link-products-management").removeClass("active");
            $("#link-store-fund").removeClass("active");
            $("#booking-div").removeClass("d-none");
            $("#revenue-statistics-div").addClass("d-none");
            $("#itemsManagmentDiv").addClass("d-none");
            $("#store-fund-div").addClass("d-none");
        });

        $("#link-products-management").on("click", function () {
            $(this).addClass("active");
            $("#link-revenue-statistics").removeClass("active");
            $("#link-booking").removeClass("active");
            $("#link-store-fund").removeClass("active");
            $("#booking-div").addClass("d-none");
            $("#revenue-statistics-div").addClass("d-none");
            $("#itemsManagmentDiv").removeClass("d-none");
            $("#store-fund-div").addClass("d-none");
        });

        $("#link-store-fund").on("click", function () {
            $(this).addClass("active");
            $("#link-revenue-statistics").removeClass("active");
            $("#link-booking").removeClass("active");
            $("#link-products-management").removeClass("active");
            $("#booking-div").addClass("d-none");
            $("#revenue-statistics-div").addClass("d-none");
            $("#itemsManagmentDiv").addClass("d-none");
            $("#store-fund-div").removeClass("d-none");
        });

        // G√°n ng√†y m·∫∑c ƒë·ªãnh v√† load d·ªØ li·ªáu ban ƒë·∫ßu
        const todayStr = formatDate(new Date());
        $("#fromDate").val(todayStr);
        $("#toDate").val(todayStr);
        fetchRevenueData();
        loadTodayOrders();

        //Load b√†n ch∆°i
        loadTables();
        loadMenuItems();

        $(document).on("click", ".table-card", function () {
            const tableId = $(this).data("id");

            // B·ªè m√†u v√†ng b√†n c≈©
            $(".table-card").removeClass("selected-table");

            // ƒê√°nh d·∫•u b√†n ƒëang ƒë∆∞·ª£c ch·ªçn
            $(this).addClass("selected-table");
            selectedTableId = tableId;

            // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt
            fetchTableDetails(tableId);
        });

        $("#confirmAddMenuBtn").on("click", function () {
            if (!selectedTableId) {
                showToastError("Vui l√≤ng ch·ªçn b√†n tr∆∞·ªõc.");
                return;
            }

            // L·∫•y ƒë∆°n ch∆∞a thanh to√°n c·ªßa b√†n
            $.ajax({
                url: `http://localhost:8080/api/order/table/${selectedTableId}/unpaid`,
                type: "GET",
                headers: { Authorization: token },
                success: function (order) {
                    if (!order || !order.id) {
                        showToastError("B√†n ch∆∞a c√≥ ƒë∆°n ƒë·ªÉ th√™m m√≥n!");
                        return;
                    }

                    const orderId = order.id;
                    const selectedItems = [];

                    $(".menu-item-card").each(function () {
                        const quantity = parseInt($(this).find(".quantity-input").val());
                        if (quantity > 0) {
                            const menuItemId = $(this).data("id");
                            selectedItems.push({
                                order: { id: orderId },
                                menuItem: { id: menuItemId },
                                quantity: quantity
                            });

                        }
                    });

                    if (selectedItems.length === 0) {
                        showToastError("Ch∆∞a ch·ªçn m√≥n n√†o ƒë·ªÉ th√™m!");
                        return;
                    }

                    // G·ªçi API th√™m t·ª´ng m√≥n v√†o ƒë∆°n
                    const requests = selectedItems.map(item => {
                        return $.ajax({
                            url: "http://localhost:8080/api/order-item",
                            type: "POST",
                            headers: { Authorization: token },
                            contentType: "application/json",
                            data: JSON.stringify(item),
                        });
                    });

                    Promise.all(requests)
                        .then(() => {
                            showToastSuccess("ƒê√£ th√™m m√≥n th√†nh c√¥ng!");
                            fetchTableDetails(selectedTableId); // Reload l·∫°i chi ti·∫øt b√†n
                        })
                        .catch(() => {
                            showToastError("C√≥ l·ªói khi th√™m m√≥n!");
                        });
                },
                error: function () {
                    showToastError("Kh√¥ng th·ªÉ l·∫•y ƒë∆°n c·ªßa b√†n n√†y.");
                }
            });
        });

        $(document).on("click", "#endTableBtn", function () {
            if (!selectedTableId) return;

            $.ajax({
                url: `http://localhost:8080/api/order/table/${selectedTableId}/unpaid/total`,
                type: "GET",
                headers: { Authorization: token },
                success: function (data) {
                    if (!data) {
                        showToastError("Kh√¥ng t√¨m th·∫•y ƒë∆°n ch∆∞a thanh to√°n.");
                        return;
                    }

                    const order = data.order;
                    const items = order.orderItems || [];
                    const tableName = order.billiardsTable?.tableName || "Kh√¥ng r√µ";
                    const hours = getPlayedHours(order.startTime, order.endTime || new Date().toISOString());
                    const playingFeePerHour = order.billiardsTable?.pricePerHour || 0;
                    const totalAmount = data.totalAmount || 0;

                    let html = `
                    <div class="container">
                        <div class="row mb-3">
                            <div class="col-sm-12">
                                <h5><i class="fa-solid fa-table"></i> B√†n: ${tableName}</h5>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-8">
                                <strong><i class="fa-solid fa-stopwatch"></i> Gi√° ch∆°i:</strong> ${hours} gi·ªù x ${playingFeePerHour.toLocaleString("vi-VN")} ƒë
                            </div>
                            <div class="col-sm-4 text-end">
                                <strong>${data.playingFee.toLocaleString("vi-VN")} ƒë</strong>
                            </div>
                        </div>
                    `;

                    // M√≥n ƒÉn
                    if (items.length > 0) {
                        html += `
                        <div class="row mb-2">
                            <div class="col-sm-12">
                                <strong><i class="fa-solid fa-utensils"></i> M√≥n ƒë√£ g·ªçi:</strong>
                            </div>
                        </div>`;

                        items.forEach(i => {
                            html += `
                            <div class="row mb-1">
                                <div class="col-sm-8">${i.menuItem?.name || "T√™n kh√¥ng r√µ"} x${i.quantity}</div>
                                <div class="col-sm-4 text-end">${(i.quantity * i.unitPrice).toLocaleString("vi-VN")} ƒë</div>
                            </div>`;
                        });
                    } else {
                        html += `
                        <div class="row mb-2">
                            <div class="col-sm-12 text-muted">Kh√¥ng c√≥ m√≥n n√†o</div>
                        </div>`;
                    }

                    html += `
                        <hr/>
                        <div class="row">
                            <div class="col-sm-8 text-end"><strong>T·ªïng c·ªông:</strong></div>
                            <div class="col-sm-4 text-end text-danger fw-bold fs-5">${totalAmount.toLocaleString("vi-VN")} ƒë</div>
                        </div>
                    </div>
                    `;

                    $("#payment-summary").html(html);
                    $("#confirmPaymentModal").modal("show");
                    $("#confirmFinishBtn").data("order-id", order.id);
                },
                error: function () {
                    showToastError("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin thanh to√°n.");
                }
            });
        });

        $("#confirmFinishBtn").on("click", function () {
            const orderId = $(this).data("order-id");
            const paymentMethod = $("#paymentMethodSelect").val();
            const staffId = localStorage.getItem("staffId");

            if (!paymentMethod) {
                showToastError("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.");
                return;
            }

            if (!staffId) {
                showToastError("Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                return;
            }

            // T·∫°o ISO datetime KH√îNG c√≥ 'Z'
            const endTime = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
                .toISOString().slice(0, 19); // V√≠ d·ª•: "2025-06-22T17:45:30"

            $.ajax({
                url: `http://localhost:8080/api/order/${orderId}/finish?endTime=${encodeURIComponent(endTime)}&paymentMethod=${paymentMethod}&staffId=${staffId}`,
                method: "PUT",
                headers: { Authorization: token },
                success: function () {
                    showToastSuccess("ƒê√£ thanh to√°n v√† k·∫øt th√∫c b√†n!");
                    $("#confirmPaymentModal").modal("hide");
                    loadTables();
                    fetchTableDetails(selectedTableId);
                },
                error: function (xhr) {
                    showToastError("C√≥ l·ªói khi k·∫øt th√∫c ƒë∆°n h√†ng! " + xhr.responseText);
                }
            });
        });

        // M·ªü modal th√™m m√≥n m·ªõi
        $("#btnAddItem").click(() => {
            $("#menuItemModal .modal-title").text("Th√™m m√≥n m·ªõi");
            $("#menuItemId").val("");
            $("#menuItemName").val("");
            $("#menuItemCategory").val("");
            $("#menuItemPrice").val("");
            $("#menuItemQuantity").val("");
            $("#menuItemModal").modal("show");
        });

        // L∆∞u m√≥n (th√™m ho·∫∑c c·∫≠p nh·∫≠t)
        $("#saveMenuItemBtn").click(() => {
            const id = $("#menuItemId").val();
            const name = $("#menuItemName").val().trim();
            const category = $("#menuItemCategory").val();
            const price = parseFloat($("#menuItemPrice").val());
            const stockQuantity = parseInt($("#menuItemQuantity").val());

            if (!name || !category || isNaN(price) || isNaN(stockQuantity) || price < 0 || stockQuantity < 0) {
                showToastError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† h·ª£p l·ªá.");
                return;
            }

            const itemData = { name, category, price, stockQuantity };
            const url = id
                ? `http://localhost:8080/api/menu-item/${id}`
                : `http://localhost:8080/api/menu-item`;
            const method = id ? "PUT" : "POST";

            $.ajax({
                url,
                method,
                headers: {
                    Authorization: token,
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(itemData),
                success: () => {
                    $("#menuItemModal").modal("hide");
                    loadMenuItemManagement();
                },
                error: function (xhr) {
                    if (xhr.status === 409) {
                        showToastError("T√™n m√≥n ƒë√£ t·ªìn t·∫°i.");
                    } else {
                        showToastError("C√≥ l·ªói x·∫£y ra khi l∆∞u m√≥n.");
                    }
                }
            });
        });

        // B·∫•m s·ª≠a
        $(document).on("click", ".editItemBtn", function () {
            const id = $(this).data("id");
            $.ajax({
                url: `http://localhost:8080/api/menu-item/${id}`,
                method: "GET",
                headers: { Authorization: token },
                success: function (item) {
                    $("#menuItemModal .modal-title").text("Ch·ªânh s·ª≠a m√≥n");
                    $("#menuItemId").val(item.id);
                    $("#menuItemName").val(item.name);
                    $("#menuItemCategory").val(item.category);
                    $("#menuItemPrice").val(item.price);
                    $("#menuItemQuantity").val(item.stockQuantity); // ‚úÖ hi·ªÉn th·ªã ƒë√∫ng s·ªë l∆∞·ª£ng
                    $("#menuItemModal").modal("show");
                },
                error: function () {
                    showToastError("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin m√≥n.");
                }
            });
        });

        // B·∫•m s·ª≠a
        $(document).on("click", ".editItemBtn", function () {
            const id = $(this).data("id");
            $.ajax({
                url: `http://localhost:8080/api/menu-item/${id}`,
                method: "GET",
                headers: { Authorization: token },
                success: function (item) {
                    $("#menuItemModal .modal-title").text("Ch·ªânh s·ª≠a m√≥n");
                    $("#menuItemId").val(item.id);
                    $("#menuItemName").val(item.name);
                    $("#menuItemCategory").val(item.category);
                    $("#menuItemPrice").val(item.price);
                    $("#menuItemQuantity").val(item.stockQuantity); // ‚úÖ hi·ªÉn th·ªã ƒë√∫ng s·ªë l∆∞·ª£ng
                    $("#menuItemModal").modal("show");
                },
                error: function () {
                    showToastError("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin m√≥n.");
                }
            });
        });

        // B·∫•m x√≥a
        $(document).on("click", ".deleteItemBtn", function () {
            const id = $(this).data("id");
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?")) {
                $.ajax({
                    url: `http://localhost:8080/api/menu-item/${id}`,
                    method: "DELETE",
                    headers: { Authorization: token },
                    success: function () {
                        loadMenuItemManagement();
                        $("#menuItemModal").modal("hide");
                    },
                    error: function () {
                        showToastError("Kh√¥ng x√≥a ƒë∆∞·ª£c m√≥n.");
                    }
                });
            }
        });

        $('#updateInitialCashBtn').click(function () {
            const staffId = localStorage.getItem('staffId');
            const cash = parseFloat($('#initialCashInput').val()) || 0;

            if (!staffId) {
                showToastError('Kh√¥ng t√¨m th·∫•y ID nh√¢n vi√™n!');
                return;
            }

            // B1: L·∫•y c√°c phi√™n l√†m vi·ªác c·ªßa nh√¢n vi√™n
            $.ajax({
                url: `http://localhost:8080/api/working-session/staff/${staffId}`,
                method: 'GET',
                success: function (sessions) {
                    const activeSession = sessions.find(s => s.endTime == null);

                    if (!activeSession) {
                        showToastError('Kh√¥ng c√≥ phi√™n ƒëang ho·∫°t ƒë·ªông!');
                        return;
                    }

                    // B2: C·ªông d·ªìn ti·ªÅn
                    const updatedCash = activeSession.cashInSession + cash;

                    // B3: G·ª≠i PUT ƒë·ªÉ c·∫≠p nh·∫≠t ti·ªÅn
                    $.ajax({
                        url: `http://localhost:8080/api/working-session/${activeSession.id}`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            id: activeSession.id,
                            startTime: activeSession.startTime,
                            endTime: null,
                            cashInSession: updatedCash,
                            staff: { id: staffId }
                        }),
                        success: function () {
                            showToastSuccess('ƒê√£ c·ªông th√™m ' + formatCurrency(cash) + ' v√†o phi√™n l√†m vi·ªác.');
                            $('#initialCashInput').val('');
                            loadWorkingSessions(0);
                        },
                        error: function () {
                            showToastError('L·ªói khi c·∫≠p nh·∫≠t ti·ªÅn qu·ªπ.');
                        }
                    });
                },
                error: function () {
                    showToastError('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin phi√™n l√†m vi·ªác.');
                }
            });
        });

    });

    /*** REGION 3 - Event handlers - V√πng khai b√°o c√°c h√†m x·ª≠ l√Ω s·ª± ki·ªán */
    function fetchRevenueData() {
        const from = $("#fromDate").val();
        const to = $("#toDate").val();

        $.ajax({
            url: `http://localhost:8080/api/report/revenue?type=date&from=${from}&to=${to}`,
            type: "GET",
            headers: { Authorization: token },
            success: function (res) {
                const labels = res.map(item => item.label);
                const data = res.map(item => item.revenue);
                renderChart(labels, data);
            },
            error: function () {
                showToastError("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu doanh thu!");
            },
        });
    }

    function loadTodayOrders() {
        const dateStr = formatDate(currentDay);
        $("#currentDateDisplay").text(formatDisplayDate(dateStr));

        $.ajax({
            url: `http://localhost:8080/api/report/orders/by-date?date=${dateStr}`,
            type: "GET",
            headers: { Authorization: token },
            success: function (orders) {
                let rows = "";
                let total = 0;
                orders.forEach(o => {
                    const detailId = `detail-${o.id}`;
                    rows += `
                    <tr>
                        <td>${o.id}</td>
                        <td>${o.billiardsTableName}</td>
                        <td>${formatDisplayDateWithTime(o.startTime)}</td>
                        <td>${formatDisplayDateWithTime(o.endTime)}</td>
                        <td>${o.paymentMethod}</td>
                        <td>${o.totalAmount.toLocaleString("vi-VN")} ƒë</td>
                        <td>
                            <i class="fa-solid fa-eye text-primary" role="button"
                            title="Xem chi ti·∫øt" data-target="${detailId}"></i>
                        </td>
                    </tr>
                    <tr id="${detailId}" class="d-none bg-light">
                        <td colspan="7">
                            <strong>Chi ti·∫øt ƒë∆°n h√†ng:</strong>
                            <ul class="mb-0">
                                ${(o.items || []).map(i => `
                                    <li>${i.name} x${i.quantity} = ${(i.unitPrice * i.quantity).toLocaleString("vi-VN")} ƒë</li>
                                `).join("")}
                                <li><strong>Gi√° ch∆°i :</strong> ${getPlayedHours(o.startTime, o.endTime)} gi·ªù = ${o.playingFee.toLocaleString("vi-VN")} ƒë</li>
                            </ul>
                        </td>
                    </tr>
                    `;
                    total += o.totalAmount;
                });
                $("#orderListBody").html(rows);
                $("#totalRevenueToday").text(total.toLocaleString("vi-VN") + " ƒë");
            },
            error: function () {
                showToastError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng!");
            }
        });
    }

    function loadTables() {
        $.ajax({
            url: "http://localhost:8080/api/billiards-table",
            type: "GET",
            headers: { Authorization: token },
            success: function (tables) {
                let html = "";
                tables.forEach(t => {
                    const isInUse = t.inUse ? 'inUsed' : '';
                    const statusText = t.inUse ? `<span class="status-text">ƒêang s·ª≠ d·ª•ng</span>` : '';
                    html += `
                        <div class="col-md-4">
                            <div class="table-card ${isInUse}" data-id="${t.id}">
                                ${t.tableName}
                                <br />
                                <span style="font-size: 14px; font-weight: normal; color: #555;">
                                    ${t.pricePerHour.toLocaleString("vi-VN")} ƒë / gi·ªù
                                </span>
                                ${statusText}
                            </div>
                        </div>
                    `;
                });
                $("#table-list").html(html);
            },
            error: function () {
                showToastError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√†n!");
            }
        });
    }

    function fetchTableDetails(tableId) {
        $.ajax({
            url: `http://localhost:8080/api/order/table/${tableId}/unpaid`,
            type: "GET",
            headers: { Authorization: token },
            success: function (order) {
                if (!order || !order.id) {
                    const emptyHtml = `
                    <h5>B√†n ch∆∞a c√≥ ƒë∆°n n√†o.</h5>
                    <button class="btn btn-primary" id="openTableBtn">
                        <i class="fa-solid fa-play"></i>&nbsp; B·∫Øt ƒë·∫ßu m·ªü b√†n
                    </button>
                `;
                    $("#table-detail-panel").html(emptyHtml);

                    $("#openTableBtn").on("click", function () {
                        const staffId = localStorage.getItem("staffId");
                        const now = new Date(Date.now() - new Date().getTimezoneOffset() * 60000).toISOString();

                        $.ajax({
                            url: "http://localhost:8080/api/order",
                            type: "POST",
                            headers: { Authorization: token },
                            contentType: "application/json",
                            data: JSON.stringify({
                                billiardsTable: { id: tableId },
                                staff: { id: parseInt(staffId) },
                                startTime: now,
                                createdAt: now,
                                isPaid: false,
                                orderItems: []
                            }),
                            success: function () {
                                showToastSuccess("B√†n ƒë√£ ƒë∆∞·ª£c m·ªü!");
                                fetchTableDetails(tableId);
                                loadTables();
                            },
                            error: function () {
                                showToastError("Kh√¥ng th·ªÉ m·ªü b√†n m·ªõi!");
                            }
                        });
                    });
                    return;
                }

                const startTime = dayjs(order.startTime);
                const startTimeFormatted = startTime.format("HH:mm:ss - DD/MM/YYYY");

                $.ajax({
                    url: `http://localhost:8080/api/order-item/order/${order.id}`,
                    type: "GET",
                    headers: { Authorization: token },
                    success: function (items) {
                        const foodList = items.map(i => {
                            const name = i.name || i.menuItem?.name || "T√™n kh√¥ng r√µ";
                            return `

                            <li data-order-item-id="${i.id}" class="d-flex mb-2" style="gap:15px;">
                                <div class="d-flex" style="gap:5px;">
                                    ${name} x<span class="quantity">${i.quantity}</span>
                                </div>
                                <div class="d-flex" style="gap:5px;">
                                    <button class="btn btn-sm btn-outline-secondary btn-increase">+</button>
                                    <button class="btn btn-sm btn-outline-secondary btn-decrease">-</button>
                                    <button class="btn btn-sm btn-outline-danger btn-remove">üóë</button>
                                </div>
                            </li>
                        `;
                        }).join("");

                        const detailHtml = `
                        <h5>B√†n: ${order.billiardsTable?.tableName || "L·ªói hi·ªÉn th·ªã"}</h5>
                        <p><strong>Gi·ªù b·∫Øt ƒë·∫ßu:</strong> <span id="start-time-display">${startTimeFormatted}</span></p>
                        <p><strong>ƒêang ch∆°i:</strong> <span id="playing-duration-display">0 gi·ªù 0 ph√∫t</span></p>
                        <p><strong>Th·ª©c ƒÉn ƒë√£ g·ªçi:</strong></p>
                        <ul>${foodList || '<li>Kh√¥ng c√≥ m√≥n n√†o</li>'}</ul>
                        <button class="btn btn-danger mt-3" id="endTableBtn">
                            <i class="fa-solid fa-stop"></i>&nbsp; K·∫øt th√∫c v√† t√≠nh ti·ªÅn
                        </button>
                    `;
                        $("#table-detail-panel").html(detailHtml);

                        // B·∫Øt ƒë·∫ßu ch·∫°y ƒë·ªìng h·ªì th·ªùi gian th·ª±c
                        startPlayingTimer(startTime);

                        // G√°n s·ª± ki·ªán tƒÉng/gi·∫£m/xo√° m√≥n ƒÉn
                        $(".btn-increase").click(function () {
                            const li = $(this).closest("li");
                            const orderItemId = li.data("order-item-id");
                            updateOrderItemQuantity(orderItemId, 1);
                        });

                        $(".btn-decrease").click(function () {
                            const li = $(this).closest("li");
                            const orderItemId = li.data("order-item-id");
                            updateOrderItemQuantity(orderItemId, -1);
                        });

                        $(".btn-remove").click(function () {
                            const li = $(this).closest("li");
                            const orderItemId = li.data("order-item-id");

                            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?")) {
                                $.ajax({
                                    url: `http://localhost:8080/api/order-item/${orderItemId}`,
                                    type: "DELETE",
                                    headers: { Authorization: token },
                                    success: function () {
                                        li.remove();
                                        showToastSuccess("ƒê√£ xo√° m√≥n kh·ªèi ƒë∆°n h√†ng");
                                    },
                                    error: function () {
                                        showToastError("Kh√¥ng th·ªÉ xo√° m√≥n");
                                    }
                                });
                            }
                        });
                    },
                    error: function () {
                        $("#table-detail-panel").html(`<p>L·ªói khi t·∫£i m√≥n ƒÉn ƒë√£ g·ªçi.</p>`);
                    }
                });
            },
            error: function () {
                $("#table-detail-panel").html(`<p>B√†n ƒëang tr·ªëng ho·∫∑c c√≥ l·ªói x·∫£y ra.</p>`);
            }
        });
    }

    function loadMenuItems() {
        $.ajax({
            url: "http://localhost:8080/api/menu-item",
            type: "GET",
            headers: { Authorization: token },
            success: function (items) {
                let html = "";
                items.forEach(item => {
                    html += `
                    <div class="col-md-3">
                        <div class="menu-item-card" data-id="${item.id}" data-name="${item.name}" data-price="${item.price}">
                            <strong>${item.name}</strong><br/>
                            <span>${item.price.toLocaleString("vi-VN")} ƒë</span><br/>
                            <input type="number" min="0" value="0" class="form-control quantity-input" placeholder="S·ªë l∆∞·ª£ng">
                        </div>
                    </div>
                `;
                });
                $("#menu-item-list").html(html);
            },
            error: function () {
                $("#menu-item-list").html(`<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i menu m√≥n!</p>`);
            }
        });
    }

    function loadMenuItemManagement() {
        $.ajax({
            url: "http://localhost:8080/api/menu-item",
            method: "GET",
            headers: { Authorization: token },
            success: function (items) {
                const tbody = $("#menuItemListBody"); // <-- s·ª≠a l·∫°i ƒë√∫ng ID
                tbody.empty();
                items.forEach(item => {
                    const row = `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.price.toLocaleString("vi-VN")}</td>
                    <td>${item.stockQuantity}</td>
                    <td>
                        <button class="btn btn-sm btn-warning editItemBtn" data-id="${item.id}">S·ª≠a</button>
                        <button class="btn btn-sm btn-danger deleteItemBtn" data-id="${item.id}">X√≥a</button>
                    </td>
                </tr>`;
                    tbody.append(row);
                });
            },
            error: function () {
                showToastError("L·ªói khi t·∫£i danh s√°ch m√≥n.");
            }
        });
    }

    function loadWorkingSessions(page) {
        $.ajax({
            url: `http://localhost:8080/api/working-session/paged?page=${page}&size=${pageSize}`,
            method: 'GET',
            success: function (data) {
                const sessions = data.content;
                const totalPages = data.totalPages;
                const tbody = $('#workingSessionTableBody');
                tbody.empty();

                let totalCash = 0;

                sessions.forEach(session => {
                    totalCash += session.cashInSession;

                    const start = formatDateTime(session.startTime);
                    const end = session.endTime ? formatDateTime(session.endTime) : '<span class="text-danger">ƒêang ho·∫°t ƒë·ªông</span>';
                    const row = `
                        <tr>
                            <td>${session.id}</td>
                            <td>${session.staff?.username || 'Kh√¥ng r√µ'}</td>
                            <td>${start}</td>
                            <td>${end}</td>
                            <td>${formatCurrency(session.cashInSession)} ƒë</td>
                        </tr>
                    `;
                    tbody.append(row);
                });

                $('#totalFundAmount').text(formatCurrency(totalCash) + ' ƒë');
                renderPagination(totalPages, page);
            },
            error: function () {
                showToastError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu qu·ªπ.');
            }
        });
    }

    /*** REGION 4 - Common functions - V√πng khai b√°o h√†m d√πng chung trong to√†n b·ªô ch∆∞∆°ng tr√¨nh */
    function formatDate(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${year}-${month}-${day}`;
    }

    function formatDisplayDate(dateStr) {
        const d = dayjs(dateStr.replace(" ", "T")).tz("Asia/Ho_Chi_Minh");
        return d.format("DD/MM/YYYY");
    }

    function formatDisplayDateWithTime(dateStr) {
        const d = dayjs(dateStr.replace(" ", "T")).tz("Asia/Ho_Chi_Minh");
        return d.format("DD/MM/YYYY HH:mm");
    }

    function renderChart(labels, data) {
        const formattedLabels = labels.map(label => {
            const parts = label.split("-");
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        });

        const ctx = document.getElementById("revenueChart").getContext("2d");
        if (revenueChart) revenueChart.destroy();
        revenueChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: "Doanh thu (VND)",
                    data: data,
                    backgroundColor: "#198754",
                    borderRadius: 5,
                }],
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString("vi-VN") + " ƒë";
                            },
                        },
                    },
                },
            },
        });
    }

    function getPlayedHours(startTime, endTime) {
        const start = dayjs(startTime);
        const end = dayjs(endTime);
        const durationInHours = end.diff(start, 'minute') / 60;
        return parseFloat(durationInHours.toFixed(2));
    }

    function startPlayingTimer(startTime) {
        if (playingTimerInterval) {
            clearInterval(playingTimerInterval);
        }

        playingTimerInterval = setInterval(() => {
            const now = dayjs();
            const duration = now.diff(startTime, 'second');
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;

            $("#playing-duration-display").text(`${hours} gi·ªù ${minutes} ph√∫t ${seconds} gi√¢y`);
        }, 1000);
    }

    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yyyy = date.getFullYear();
        const hh = String(date.getHours()).padStart(2, '0');
        const mi = String(date.getMinutes()).padStart(2, '0');
        const ss = String(date.getSeconds()).padStart(2, '0');
        return `${hh}:${mi}:${ss} ${dd}/${mm}/${yyyy}`;
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('vi-VN').format(value);
    }

    function renderPagination(totalPages, activePage) {
        const pagination = $('#pagination');
        pagination.empty();

        for (let i = 0; i < totalPages; i++) {
            const li = $(`
                <li class="page-item ${i === activePage ? 'active' : ''}">
                    <a class="page-link" href="#">${i + 1}</a>
                </li>
            `);
            li.click(() => {
                currentPage = i;
                loadWorkingSessions(currentPage);
            });
            pagination.append(li);
        }
    }

    function updateOrderItemQuantity(orderItemId, delta) {
        $.ajax({
            url: `http://localhost:8080/api/order-item/${orderItemId}/update-quantity`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ delta }),
            headers: { Authorization: token },
            success: function (updatedItem) {
                const li = $(`li[data-order-item-id="${orderItemId}"]`);
                if (updatedItem.quantity > 0) {
                    li.find(".quantity").text(updatedItem.quantity);
                    showToastSuccess("C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th√†nh c√¥ng");
                } else {
                    li.remove();
                    showToastSuccess("ƒê√£ xo√° m√≥n v√¨ s·ªë l∆∞·ª£ng b·∫±ng 0");
                }
            },
            error: function () {
                showToastError("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng");
            }
        });
    }

    function showToast(type, message) {
        const icon = type === "success" ? "‚úÖ" : "‚ùå";
        const bgColor = type === "success" ? "bg-success" : "bg-danger";
        const textColor = "text-white";

        const toastId = `toast-${Date.now()}`;

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center ${bgColor} ${textColor}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000" style="min-width: 350px; font-size: 1.1rem;">
                <div class="d-flex">
                    <div class="toast-body py-3 px-4">
                        ${icon} ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-3 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        $("#toast-container").append(toastHtml);
        const toastElement = new bootstrap.Toast(document.getElementById(toastId));
        toastElement.show();

        $(`#${toastId}`).on("hidden.bs.toast", function () {
            $(this).remove();
        });
    }


    function showToastSuccess(message) {
        showToast("success", message);
    }

    function showToastError(message) {
        showToast("error", message);
    }
</script>

</html>